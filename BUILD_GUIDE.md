# DPM Shared Library - Build & Distribution Guide

## Overview

The `dpm-shared` library is a component and styling library designed to be consumed by other packages in the monorepo. It provides:

- **Components**: Reusable React UI components
- **Styles**: Tree-shakeable Tailwind CSS compiled to a standalone CSS file
- **Utilities**: Helper functions and types

## Build System

### Build Process

The build process is handled by npm scripts defined in `package.json`:

```json
{
  "build": "tsc && npm run build:styles",
  "build:styles": "npm run build:tailwind && npm run copy:css",
  "build:tailwind": "tailwindcss -i ./src/styles/globals.css -o ./dist/styles/index.css --minify",
  "copy:css": "mkdir -p dist/styles && cp src/App.css dist/styles/components.css 2>/dev/null || true"
}
```

#### Step 1: TypeScript Compilation
- **Command**: `tsc`
- **Output**: JavaScript files and type definitions in `dist/`
- **Config**: `tsconfig.json`

#### Step 2: Tailwind CSS Build
- **Command**: `tailwindcss -i ./src/styles/globals.css -o ./dist/styles/index.css --minify`
- **Input**: `src/styles/globals.css`
- **Output**: Minified `dist/styles/index.css`
- **Features**: 
  - Scans all source files for Tailwind classes
  - Tree-shakes unused styles
  - Minifies for production

#### Step 3: Copy Component Styles
- **Command**: Copies `src/App.css` to `dist/styles/components.css`
- **Purpose**: Component-specific CSS that isn't Tailwind-based

### Running the Build

From the `shared-lib` directory:
```bash
pnpm build
```

Or from the monorepo root:
```bash
pnpm build
```

This will rebuild all packages including `dpm-shared`.

## Package.json Configuration

### Key Fields

```json
{
  "sideEffects": ["dist/**/*.css"],
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "types": "./dist/index.d.ts"
    },
    "./styles": {
      "import": "./dist/styles/index.css"
    },
    "./button": {
      "import": "./dist/components/Button.js",
      "types": "./dist/components/Button.d.ts"
    }
  }
}
```

#### `sideEffects`
- Declares that CSS files have side effects (must be bundled)
- Allows bundlers to properly handle CSS imports
- Format: `["dist/**/*.css"]`

#### `exports`
- Defines all public entry points
- Allows consumers to import specific exports
- Each export can specify import and types separately

## Consumption

### From Other Packages

#### Basic Usage
```typescript
// Import components
import { Button, Counter } from 'dpm-shared';

// Import styles (must be imported to apply CSS)
import 'dpm-shared/styles';
```

#### Specific Imports
```typescript
// Import only Button
import { Button } from 'dpm-shared/button';

// Import without styles (manual CSS management)
import { Counter } from 'dpm-shared/counter';
```

### In the App Package

The main app (`app/`) already imports styles in `src/main.tsx`:
```typescript
import 'dpm-shared/styles';
import './index.css';
```

This ensures:
1. Shared library styles are loaded first
2. App-specific styles can override if needed

## CSS Architecture

### File Structure
```
src/styles/
├── globals.css       # Main entry point for Tailwind
├── components.css    # (Optional) Component-specific styles
└── ...
```

### globals.css Layers

The Tailwind CSS layers are organized as follows:

```css
@layer base {
  /* Reset and base element styles */
}

@layer components {
  /* Reusable component classes */
  .dpm-button { ... }
  .dpm-button-primary { ... }
}

@layer utilities {
  /* Utility classes (auto-generated by Tailwind) */
}
```

### Using Component Classes

```tsx
<button className="dpm-button dpm-button-primary">
  Click me
</button>
```

## Tree-Shaking

The library is designed for optimal tree-shaking:

- **CSS**: Tailwind uses content configuration to only include used classes
- **Components**: TypeScript modules are separate, allowing bundlers to remove unused code
- **Side Effects**: CSS imports are marked as side effects so they're always included

## Development Workflow

### Making Changes

1. **Add/modify components** in `src/components/`
2. **Update component exports** in `src/components/index.ts`
3. **Add component styles** to `src/styles/globals.css`
4. **Export new entry point** in `package.json` (if needed)

### Testing Changes Locally

From the shared-lib root:
```bash
pnpm dev          # Watch mode for TypeScript
pnpm build        # Full build
```

Then in the app:
```bash
pnpm dev          # Hot reload should pick up changes
```

### Building Before Publishing

Always build before committing or deploying:
```bash
pnpm build
```

This ensures:
- TypeScript is compiled
- CSS is processed and minified
- All outputs are in `dist/`

## Distribution

### Output Files

After running `pnpm build`, the `dist/` directory contains:

```
dist/
├── index.js                    # Main entry point
├── index.d.ts                  # Type definitions
├── components/
│   ├── Button.js
│   ├── Button.d.ts
│   ├── counter.js
│   └── counter.d.ts
├── api/
│   ├── index.js
│   └── index.d.ts
└── styles/
    ├── index.css               # Compiled Tailwind styles
    └── components.css          # Component styles
```

### Publishing

When ready to publish to npm:

1. Build the library: `pnpm build`
2. Update version in `package.json`
3. Publish: `npm publish` (from shared-lib directory)

## Troubleshooting

### Styles not applying
- Ensure `import 'dpm-shared/styles'` is in main entry point
- Check that `sideEffects` is properly configured in `package.json`
- Verify CSS output exists in `dist/styles/index.css`

### Missing exports
- Verify new exports are added to `package.json` exports field
- Rebuild the library: `pnpm build`

### Build fails
- Check Node version: `node --version` (requires Node 20+)
- Clear node_modules: `rm -rf node_modules && pnpm install`
- Check TypeScript errors: `pnpm run tsc`

## References

- [Node Package.json Exports](https://nodejs.org/api/packages.html#exports)
- [Tailwind CSS Content Configuration](https://tailwindcss.com/docs/content-configuration)
- [Side Effects in Webpack](https://webpack.js.org/guides/tree-shaking/#mark-the-file-as-side-effect-free)
