# ---------------------------------------------------------------------------------
# Quy trình CI/CD: Tự động Build và Publish thư viện UI lên Azure Artifacts
# ---------------------------------------------------------------------------------

trigger:
  branches:
    include:
      - develop
      - master
      - release/*

pool:
  name: 'AgentDocker'

variables:
  major: '1'
  minor: '0'
  patch: $[counter(format('{0}.{1}', variables['major'], variables['minor']), 0)]
  sharedVersion: '$(major).$(minor).$(patch)'
  project: 'DPM.Platform'
  feedName: 'DPM.UI.Shared'
  targetFeedUrl: 'https://devopsrc.vuthao.com/SourceCode/$(project)/_packaging/$(feedName)/npm/registry/'

name: $(sharedVersion)

stages:
  - stage: Build
    displayName: "Stage 1: Build & Test"
    jobs:
      - job: build
        displayName: "Kiểm tra và Biên dịch"
        steps:
          - checkout: self
            fetchDepth: 0

          - task: NodeTool@0
            displayName: "Cài đặt môi trường Node.js (24.x)"
            inputs:
              versionSpec: '24.x'

          - script: |
              call corepack enable
              call corepack prepare pnpm@10.19.0 --activate
              call pnpm install --frozen-lockfile
              call pnpm run build
            displayName: "Pnpm Install & Build"

  - stage: Publish
    displayName: "Stage 2: Publish to Artifacts"
    dependsOn: Build
    condition: |
      and(
        succeeded(),
        or(eq(variables['Build.SourceBranch'], 'refs/heads/master'), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
      )
    jobs:
      - job: publish
        displayName: "Đẩy thư viện lên Feed"
        steps:
          - checkout: self

          - task: NodeTool@0
            inputs:
              versionSpec: '24.x'

          - task: npmAuthenticate@0
            displayName: "Xác thực quyền ghi vào Feed Artifacts"
            inputs:
              workingFile: .npmrc

          - script: |
              call corepack enable
              call corepack prepare pnpm@10.19.0 --activate
              echo "Cau hinh phien ban: $(sharedVersion)"
              call pnpm version $(sharedVersion) --no-git-tag-version
              
              :: Su dung --no-scripts de tranh loi khong tim thay Husky tren Agent
              call pnpm publish --registry $(targetFeedUrl) --no-git-checks --no-scripts
            displayName: "Đóng gói & Đẩy lên Azure Artifacts"